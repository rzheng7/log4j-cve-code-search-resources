name: upgrade-log4j-cve-2021-44228-sbt
description: Detects dependencies on log4j jars that are affected by [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)

on:
  - repositoriesMatchingQuery: file:project/build.properties sbt.version

# In each repository,
steps:
  - run: |
      cat << 'EOF' >> project/Log4shellPlugin.scala
      package com.sourcegraph.sbtsourcegraph
      
      import sbt._
      import sbt.Keys._
      import sbt.plugins.JvmPlugin
      import java.util.jar.JarFile
      
      object Log4shellPlugin extends AutoPlugin {
        override def trigger: PluginTrigger = allRequirements
        override def requires = JvmPlugin
        object autoImport {
          val detectVulnerableLog4j = taskKey[Unit](
            "reports an error if we detect a vulnerable log4j dependency"
          )
        }
        import autoImport._
        override def projectSettings: Seq[Setting[_]] =
          List(Compile, Test).flatMap(c =>
            inConfig(c)(
              List(
                detectVulnerableLog4j := {
                  val projectName = thisProject.value.id
                  val l = streams.value.log
                  dependencyClasspath.value.foreach { entry =>
                    analyzeDependencyClasspathEntry(projectName, c, entry.data, l)
                  }
                }
              )
            )
          )
      
        def analyzeDependencyClasspathEntry(
            projectName: String,
            config: Configuration,
            file: File,
            logger: Logger
        ): Unit = {
          if (file.getName().endsWith(".jar")) {
            val jar = new JarFile(file)
            val entries = jar.entries()
            try {
              while (entries.hasMoreElements()) {
                val element = entries.nextElement()
                if (
                  element.getName() == "org/apache/logging/log4j/core/lookup/JndiLookup.class"
                ) {
                  logger.error(
                    s"CVE-2021-44228: the config '${config.name}' in the project '$projectName' depends on a vulnerable jar file ${file.absolutePath}"
                  )
                }
              }
            } finally {
              jar.close()
            }
          }
        }
      }
      EOF
      curl -L https://raw.githubusercontent.com/sbt/sbt/develop/sbt > sbt
      chmod +x sbt
      ./sbt detectVulnerableLog4j | grep CVE-2021-44228 > "$OUTPUT_FILE"
    container: openjdk:11
    env:
      OUTPUT_FILE: "fixme-log4j-vulnerabilities.txt"

# Describe the changeset (e.g., GitHub pull request) you want for each repository.
changesetTemplate:
  title: Detected vulnerable log4j dependency (CVE-2021-44228)
  body: |
    This PR identifies jar files that are on the classpath of this codebase that are affected by [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228).
    Please urgently fix this issue by following the steps in TODO.
  branch: batches/detect-log4j-cve-2021-44228-maven
  commit:
    message: Detect log4j vulnerability (CVE-2021-44228)
  published: false
