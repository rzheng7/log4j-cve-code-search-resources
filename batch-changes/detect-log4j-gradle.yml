name: detect-log4j-cve-2021-44228-gradle
description: Detects dependencies on log4j jars that are affected by [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)

# Find all repositories that use Gradle (and have build.gradle files). We intentionally don't
# restrict to only repositories whose Gradle files include log4j, because we want to fix instances
# where log4j is a transitive (indirect) dependency as well (and in those cases, there would not be
# any files mentioning log4j).
on:
  - repositoriesMatchingQuery: file:build.gradle repo:sgtest/sample-vulnerable-log4j

# In each repository,
steps:
  - run: |
      cat << 'EOF' >> /tmp/gradle-script
      allprojects {
          gradle.projectsEvaluated {
              task detectLog4jVulnerability {
                  doLast {
                      try {
                        project.configurations.forEach { config ->
                            if (config.canBeResolved) {
                                config.each { f ->
                                    def isJar = f.name.endsWith(".jar")
                                    if (isJar) {
                                        def jar = new java.util.jar.JarFile(f)
                                        def entries = jar.entries()
                                        try {
                                            while (entries.hasMoreElements()) {
                                                def entry = entries.nextElement()
                                                if (entry.name == "org/apache/logging/log4j/core/lookup/JndiLookup.class") {
                                                    println 'project "$project.name' has $config that depends on a vulnerable jar file $f.absolutePath'
                                                }
                                            }
                                        } finally {
                                            jar.close()
                                        }
                                    }
                                }
                            }
                        }
                      } catch (Exception e) {}
                  }
              }
          }
      }
      EOF

      ./gradlew -q --init-script /tmp/gradle-script detectLog4jVulnerability >> "$OUTPUT_FILE"
    container: gradle:7.3.1-jdk11
    env:
      OUTPUT_FILE: "fixme-log4j-vulnerabilities.txt"

# Describe the changeset (e.g., GitHub pull request) you want for each repository.
changesetTemplate:
  title: Detected vulnerable log4j dependency (CVE-2021-44228)
  body: |
    This PR identifies jar files that are on the classpath of this codebase that are affected by [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228).
    Please urgently fix this issue by following the steps in TODO.
  branch: batches/detect-log4j-cve-2021-44228-gradle
  commit:
    message: Detect log4j vulnerability (CVE-2021-44228)
  published: false
