allprojects {
    gradle.projectsEvaluated {
        task detectLog4jVulnerability {
            doLast {
                project.configurations.forEach { config ->
                    if (config.canBeResolved) {
                        config.each { f ->
                            def isJar = f.name.endsWith(".jar")
                            if (isJar) {
                                def jar = new java.util.jar.JarFile(f)
                                def entries = jar.entries()
                                try {
                                    while (entries.hasMoreElements()) {
                                        def entry = entries.nextElement()
                                        if (entry.name == "org/apache/logging/log4j/core/lookup/JndiLookup.class") {
                                            println "project '$project.name' has $config that depends on a vulnerable jar file $f.absolutePath"
                                        }
                                    }
                                } finally {
                                    jar.close()
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}