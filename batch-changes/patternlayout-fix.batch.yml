name: cve-2021-44228-patternlayout-fix
description: Change PatternLayout to mitigate CVE-2021-44228  

# Use structural search to identify patterns to replace (see docs for more info: https://docs.sourcegraph.com/code_search/reference/structural)
on:
  - repositoriesMatchingQuery: <PatternLayout pattern=":[var]%m:[var3]" patterntype:structural

# Uses comby to create the change https://comby.live/
steps:
  - run: comby -in-place '<PatternLayout pattern=":[var]%m:[var2~[^{]]:[var3]"/>' '<PatternLayout pattern=":[var]%m{nolookups}:[var2]:[var3]"/>' ${{ join repository.search_result_paths " " }}
    container: comby/comby

changesetTemplate:
  title: Change PatternLayout to use nolookups converter (CVE-2021-44228)
  body: Replace the %m message converter by %m{nolookups} in PatternLayout to fix [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) for log4j releases >=2.7 and <=2.14.1.
  branch: batch-changes/cve-2021-44228 # Push the commit to this branch.
  commit:
    message: use nolookups converter - CVE-2021-44228
  published: false
