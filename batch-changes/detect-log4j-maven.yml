name: detect-log4j-multi-cve-maven
description: Detects dependencies on log4j jars that are affected by [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) or [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046)

# Find all repositories that use Maven (and have pom.xml files). We intentionally don't
# restrict to only repositories whose Maven files include log4j, because we want to fix instances
# where log4j is a transitive (indirect) dependency as well (and in those cases, there would not be
# any files mentioning log4j).
on:
  - repositoriesMatchingQuery: file:pom.xml

# In each repository,
steps:
  - run: |
      WORKING_DIRECTORY="$(pwd)"
      for mavenScript in $(find . -name mvnw -type f); do 
        cd "$(dirname $mavenScript)"
        ./mvnw dependency:build-classpath -Dmdep.includeScope=runtime -Dmdep.outputFile=classpath.txt >/dev/null
        for classpathFile in $(find . -name classpath.txt -type f); do
            for dep in $(cat "$classpathFile" | tr ":" "\n"); do
              jar tf "$dep" | grep org/apache/logging/log4j/core/lookup/JndiLookup.class && echo "file $(pwd)/$classpathFile contains affected jar $dep" >> $OUTPUT_FILE
            done
        done
        cd "$WORKING_DIRECTORY"
      done
    container: maven:3.8.4-jdk-11
    env:
      OUTPUT_FILE: "fixme-log4j-vulnerabilities.txt"

# Describe the changeset (e.g., GitHub pull request) you want for each repository.
changesetTemplate:
  title: Detected vulnerable log4j dependency (CVE-2021-44228, CVE-2021-45046)
  body: |
    This PR identifies jar files that are on the classpath of this codebase that are affected by [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228).
    Please urgently fix this issue by following the steps in TODO.
  branch: batches/detect-log4j-multi-cve-maven
  commit:
    message: Detect log4j vulnerability (CVE-2021-44228, CVE-2021-45046)
  published: false
